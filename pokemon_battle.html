<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <img
      src="/assets/bakgrunnsbilde.jpg"
      alt="bakgrunnsbilde"
      style="position: fixed; top: 0; left: 0; width: 100%"
    />
    <div class="main-container">
      <!--FIENDE-->
      <div class="enemy-health-container">
        <div class="healthbar-container">
          <div class="healthbar enemy-health"></div>
          <div class="text-container">
            <p id="enemy-name-txt">Fiendens navn</p>
            <p id="enemy-health-txt"></p>
          </div>
        </div>
      </div>

      <!--MIN POKEMON-->
      <div class="my-pokemon-health-container">
        <div class="healthbar-container">
          <div class="healthbar my-pokemon-health"></div>
          <div class="text-container">
            <p id="my-pokemon-name"></p>
            <p id="my-pokemon-health-txt"></p>
          </div>
        </div>
      </div>
      <!--Container med min pokemons attacks -->
      <div class="my-attack-container">
        <ul id="skills-list">
          <li class="skill">Skill 1</li>
          <li class="skill">Skill 2</li>
          <li class="skill">Skill 3</li>
          <li class="skill">Skill 4</li>
        </ul>
      </div>

      <!-- Bildenontainere fienden -->
      <div class="enemy-container">
        <div class="img-container enemy"></div>
      </div>
      <!-- Bildecontainer for min pokemon-->
      <div class="my-pokemon-container">
        <div class="img-container my-pokemon"></div>
      </div>
    </div>

    <script>
      let enemiesArray = [];
      let myPokemonsArray = [];
      let pokemonId;
      let enemy;

      async function fetchRandomPokemon() {
        console.log("Inne i fetchRandomPokemon");
        try {
          const randomPokemon = [];
          for (let i = 0; i < 3; i++) {
            const randomPokemonId = Math.floor(Math.random() * 250) + 1;
            const randomPokemonRequest = await fetch(
              "https://pokeapi.co/api/v2/pokemon/" + randomPokemonId
            );
            const randomPokemonData = await randomPokemonRequest.json();
            randomPokemon.push(randomPokemonData);
          }

          return randomPokemon;
        } catch {
          console.error("Feil ved innlastning av Random Pokemon!");
        }
      }

      async function fetchPokemonImg() {
        try {
          const randomPokemonData = await fetchRandomPokemon();
          const enemyId = randomPokemonData[0].id;
          const myPokemonId = randomPokemonData[1].id;

          const enemyImgUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${enemyId}.png`;

          const myPokemonImgUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${myPokemonId}.png`;

          const enemyContainer = document.querySelector(
            ".enemy-container .img-container.enemy"
          );
          enemyContainer.innerHTML = `<img src="${enemyImgUrl}" alt="Fiendens bilde">`;

          const myPokemonContainer = document.querySelector(
            ".my-pokemon-container .img-container"
          );
          myPokemonContainer.innerHTML = `<img src="${myPokemonImgUrl}" alt="Din Pokemons bilde">`;
        } catch (error) {
          console.error("Feil ved lasting av bilde", error);
        }
      }

      async function fetchRandomPokemonData(pokemonId) {
        try {
          const pokemonDataRequest = await fetch(
            `https://pokeapi.co/api/v2/pokemon/${pokemonId}`
          );
          const data = await pokemonDataRequest.json();

          return data;
        } catch {
          console.error("Klarte ikke å hente Pokemons HP");
        }
      }

      async function fetchStatsFromApi(pokemonId) {
        try {
          const pokemonStatsDataRequest = await fetch(
            `https://pokeapi.co/api/v2/stat/`
          );
          const stats = await pokemonStatsDataRequest.json();

          return stats;
        } catch (error) {
          console.error("Klarte ikke hente stats fra API", error);
        }
      }

      async function fetchBerries() {
        try {
          const fetchBerriesRequest = await fetch(
            `https://pokeapi.co/api/v2/berry/`
          );
          const berry = await fetchBerriesRequest.json();
          return berry;
        } catch (error) {
          console.error("klarte ikke fetche berry", error);
        }
      }

      async function showPokemonImages() {
        try {
          await fetchPokemonImg();
        } catch (error) {
          console.error("Kunne ikke laste inn bilder", error);
        }
      }

      async function addPokemonNameData() {
        try {
          const randomPokemon = await fetchRandomPokemon();
          const enemyData = await fetchRandomPokemonData(randomPokemon[0].id);
          const myPokemonData = await fetchRandomPokemonData(
            randomPokemon[1].id
          );

          const enemyHP = getHP(enemyData);
          const myPokemonHP = getHP(myPokemonData);

          document.querySelector("#enemy-name-txt").innerHTML =
            randomPokemon[0].name;
          document.querySelector(
            "#enemy-health-txt"
          ).innerHTML = `HP: ${enemyHP}`;
          document.querySelector("#my-pokemon-name").innerHTML =
            randomPokemon[1].name;
          document.querySelector(
            "#my-pokemon-health-txt"
          ).innerHTML = `HP: ${myPokemonHP}`;

          //hente inn containers til styling
          const enemyHealthContainer = document.querySelector(
            ".enemy-health-container"
          );
          const myPokemonHealtContainer = document.querySelector(
            ".my-pokemon-health-container"
          );
          const enemyContainer = document.querySelector(".enemy-container");
          const myPokemonContainer = document.querySelector(
            ".my-pokemon-container"
          );
          const healthBarTxt = document.querySelectorAll(".text-container");

          const healthbarContainers = document.querySelectorAll(
            ".healthbar-container"
          );

          const enemyImg = document.querySelector(".img-container.enemy img");
          const myPokemonImg = document.querySelector(
            ".img-container.my-pokemon img"
          );

          //style health-bars
          healthBarTxt.forEach((container) => {
            container.style.color = "green";
            container.style.display = "flex";
            container.style.alignItems = "center";
            container.style.justifyContent = "space-between";
            container.style.margin = "7px";
          });

          //style begge containers
          healthbarContainers.forEach((container) => {
            container.style.width = "250px";
            container.style.height = "60px";
            container.style.border = "2px solid black";
          });

          //fiende healhbar
          enemyHealthContainer.style.backgroundColor = "lightgreen";
          enemyHealthContainer.style.position = "fixed";
          enemyHealthContainer.style.left = "50px";

          //myPokemon healthbar
          myPokemonHealtContainer.style.backgroundColor = "pink";
          myPokemonHealtContainer.style.position = "fixed";
          myPokemonHealtContainer.style.right = "50px";
          myPokemonHealtContainer.style.bottom = "150px";

          //style fiendens bildecontainer
          enemyContainer.style.position = "fixed";
          enemyContainer.style.top = "350px";
          enemyContainer.style.right = "100px";
          enemyContainer.style.width = " 300px";

          //style bildestørrelse
          enemyImg.style.width = "150px";
          myPokemonImg.style.width = "350px";

          //style myPokemons bildecontainer
          myPokemonContainer.style.position = "fixed";
          myPokemonContainer.style.bottom = "50px";
          myPokemonContainer.style.left = "200px";

          //Fetch og display skills (move)
          //Oppdatere Attack-container med myPokemonMoves
          const myPokemonMoves = myPokemonData.moves
            .slice(0, 3)
            .map((move) => move.move.name);

          //EnemyMoves skal lagres skjult
          const skillItems = document.querySelectorAll("#skills-list .skill");
          const enemyMoves = enemyData.moves
            .slice(0, 4)
            .map((move) => move.move.name);

          skillItems.forEach((item, index) => {
            item.textContent = myPokemonMoves[index];
          });

          const berryData = await fetchBerries();
          if (berryData && berryData.results && berryData.results.length > 0) {
            const berryName = berryData.results[0].name;
            skillItems[3].textContent = berryName;
          }

          return { enemyHP, myPokemonHP };
        } catch (error) {
          console.error("Feil ved oppdatering av navn på Pokemon", error);
        }
      }

      //hente inn attack-container og skills
      const myPokemonContainer = document.querySelector(".my-attack-container");
      const skills = document.querySelector(".skill");

      //Styling av attack-container
      myPokemonContainer.style.backgroundColor = "lightGrey";
      myPokemonContainer.style.border = "5px double Black";
      myPokemonContainer.style.width = "400px";
      myPokemonContainer.style.position = "fixed";
      myPokemonContainer.style.bottom = "0";

      //styling tekst inni container
      const skillsList = document.querySelector("#skills-list");
      skillsList.style.display = "grid";
      skillsList.style.gridTemplateColumns = "auto auto";
      skillsList.style.listStyleType = "none";

      showSkills = [];
      //skills heter "MOVE" i PokeAPI

      showSkills.forEach((skill) => {
        skill.addEventListener("click", function () {
          alert(
            `${myPokemonId} har angrepet med ${skill}. ${enemyId} har nå ${enemyData}HP igjen!`
          );
        });
      });

      async function saveEnemyMoves() {
        try {
          const randomPokemon = await fetchRandomPokemon();
          const enemyData = await fetchRandomPokemonData(randomPokemon[0].id);

          if (enemyData.moves && enemyData.moves.length > 0) {
            const enemySkills = enemyData.moves
              .slice(0, 4)
              .map((move) => move.move.name);

            sessionStorage.setItem("enemySkills", JSON.stringify(enemySkills));
          }
        } catch (error) {
          console.error(
            "Klarte ikke å lagre fiendens skills i sessionStorage",
            error
          );
        }
      }

      function getHP(pokemonData) {
        return pokemonData.stats.find((stat) => stat.stat.name === "hp")
          .base_stat;
      }

      async function addDataToArrays() {
        try {
          const { enemyHP, myPokemonHP } = await addPokemonNameData();

          const randomPokemon = await fetchRandomPokemon(); //henter fetched pokemons imnn til funksjonen
          const enemyData = randomPokemon[0]; //skiller mellom fiende og mine pokemons
          const myPokemonData = randomPokemon[1];

          enemy = {
            id: enemyData.id,
            name: enemyData.name,
            maxHP: enemyHP,
            currentHP: enemyHP,
            alive: true,
          };

          enemiesArray.push(enemy);

          myPokemon = {
            id: myPokemonData.id,
            name: myPokemonData.name,
            maxHP: myPokemonHP,
            currentHP: myPokemonHP,
            alive: true,
          };

          myPokemonsArray.push(myPokemon);
        } catch (error) {
          console.error("Klarte ikke legge til i Arrays", error);
        }
      }

      //STARTER SPILLET
      const moveBtn = document.querySelectorAll(".skill");

      function generateRandomDamage(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      moveBtn.forEach((skill) => {
        skill.addEventListener("click", async function () {
          // kode som lager angrep - hente stats

          const selectedSkill = skill.textContent;
          const damage = generateRandomDamage(5, 20);

          console.log("Skill-elementet ble klikket på:", skill.textContent);

          if (selectedSkill !== "skill 4") {
            enemy.currentHP -= damage;

            console.log(`${selectedSkill} forårsaker ${damage} HP skade.`);

            document.querySelector(
              "#enemy-health-txt"
            ).textContent = `HP: ${enemy.currentHP}`;
          } else {
            useCherry();
          }
          myPokemonAttack();
        });

        function useCherry() {
          const boostHP = 10;
          myPokemon.currentHP += boostHP;

          document.querySelector(
            "#my-pokemon-health-txt"
          ).textContent = `HP: ${myPokemon.currentHP}`;
        }

        const cherrySkill = document.querySelectorAll("#skills-list .skill")[3];
        cherrySkill.addEventListener("click", function () {
          useCherry();
        });
      });

      function myPokemonAttack() {
        if (parseInt(myPokemon.currentHP) < 0) {
          myPokemon[(0, 1, 2)].alive = false;
          const mySelectedPokemon = document.querySelectorAll(
            `.img-container .my-pokemon".${myPokemon.id}`
          );
          mySelectedPokemon.remove();
          alert("Dine Pokémons har ingen HP igjen, spillet er tapt!");
        }
      }

      function enemyAttack() {
        if (parseInt(enemy.currentHP) < 0) {
          myPokemon[(0, 1, 2)].alive = false;
          const selectedEnemy = document.querySelectorAll(
            `.img-container .enemy".${enemy.id}`
          );
          selectedEnemy.remove();
          alert(`${myPokemon.name} har slått ut ${enemy.name}`);
        }
      }

      showPokemonImages();
      addPokemonNameData();
      saveEnemyMoves();
      addDataToArrays();
    </script>
  </body>
</html>
